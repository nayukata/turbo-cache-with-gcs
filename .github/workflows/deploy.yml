# Google Cloudã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
name: Deploy to Google Cloud

# ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«å®Ÿè¡Œ
on:
  push:

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
env:
  # GCPé–¢é€£ã®è¨­å®š
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }} # GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
  REGION: asia-northeast1 # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆæ±äº¬ï¼‰
  SERVICE_NAME: turbo-demo-web # Cloud Runã‚µãƒ¼ãƒ“ã‚¹å

  # Artifact Registryï¼ˆDockerã‚¤ãƒ¡ãƒ¼ã‚¸ä¿å­˜ï¼‰ã®è¨­å®š
  REGISTRY: ${{ secrets.GCP_PROJECT_ID }} # ãƒ¬ã‚¸ã‚¹ãƒˆãƒªå
  REPOSITORY: turbo-demo # ãƒªãƒã‚¸ãƒˆãƒªå
  IMAGE_NAME: web # ã‚¤ãƒ¡ãƒ¼ã‚¸å

  # âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒãƒ¼ Turborepoãƒªãƒ¢ãƒ¼ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
  TURBO_API: ${{ secrets.TURBO_API }} # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒãƒ¼ã‚µãƒ¼ãƒãƒ¼URL
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }} # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒãƒ¼èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }} # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒãƒ¼ãƒãƒ¼ãƒ å

# å¿…è¦ãªæ¨©é™
permissions:
  id-token: write # OIDCèªè¨¼ç”¨
  contents: read # ãƒªãƒã‚¸ãƒˆãƒªèª­ã¿å–ã‚Šç”¨

jobs:
  deploy:
    name: ãƒ“ãƒ«ãƒ‰ & ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest

    steps:
      # 1. ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å–å¾—
        uses: actions/checkout@v4

      # 2. pnpmï¼ˆé«˜é€Ÿãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼‰ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: pnpmã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: pnpm/action-setup@v3
        with:
          version: 10

      # 3. Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆpnpmã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ãï¼‰
      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm' # pnpmã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–

      # 4. âœ… Turboã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«+ãƒªãƒ¢ãƒ¼ãƒˆå¯¾å¿œï¼‰
      - name: Turboã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ runner.os }}-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            turbo-${{ runner.os }}-${{ github.ref_name }}-
            turbo-${{ runner.os }}-

      # 5. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install --frozen-lockfile

      # 6. âœ… ãƒªãƒ¢ãƒ¼ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¥ç¶šãƒ†ã‚¹ãƒˆ
      - name: ãƒªãƒ¢ãƒ¼ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¥ç¶šãƒ†ã‚¹ãƒˆ
        run: |
          echo "ğŸ” ãƒªãƒ¢ãƒ¼ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®šã‚’ç¢ºèª..."
          echo "TURBO_API: ${{ env.TURBO_API }}"
          echo "TURBO_TEAM: ${{ env.TURBO_TEAM }}"
          echo "TURBO_TOKEN: [è¨­å®šæ¸ˆã¿]"

          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          if [ -n "${{ env.TURBO_API }}" ]; then
            echo "ğŸ“¡ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒãƒ¼ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯..."
            curl -f "${{ env.TURBO_API }}/health" || echo "âš ï¸ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—ï¼ˆã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ãªã„å¯èƒ½æ€§ï¼‰"
          fi

      # 7. âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒãƒ¼ãƒªãƒ¢ãƒ¼ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
      - name: Turborepoã§ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œï¼ˆãƒªãƒ¢ãƒ¼ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹ï¼‰
        run: |
          # Turbo CLIã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pnpm add -g turbo

          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒãƒ¼ãƒªãƒ¢ãƒ¼ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
          # ç’°å¢ƒå¤‰æ•°ï¼ˆTURBO_API, TURBO_TOKEN, TURBO_TEAMï¼‰ãŒè‡ªå‹•é©ç”¨
          turbo run build --cache-dir=.turbo --verbosity=2

      # 8. Google Cloudã¸ã®èªè¨¼
      - name: Google Cloudèªè¨¼
        uses: google-github-actions/auth@v2
        with:
          token_format: 'access_token'
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}

      # 9. Dockerã‚’Artifact Registryç”¨ã«è¨­å®š
      - name: Dockerèªè¨¼è¨­å®š
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # 10. Docker Buildxã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å¯¾å¿œï¼‰
      - name: Docker Buildxã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: docker/setup-buildx-action@v3

      # 11. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰&ãƒ—ãƒƒã‚·ãƒ¥
      - name: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ & ãƒ—ãƒƒã‚·ãƒ¥
        uses: docker/build-push-action@v6
        with:
          context: . # ãƒ“ãƒ«ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
          file: ./Dockerfile # Dockerãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
          push: true # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥
          platforms: linux/amd64 # âœ… ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ˜ç¤º
          # âœ… Turborepoãƒªãƒ¢ãƒ¼ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ã®ç’°å¢ƒå¤‰æ•°ã‚’ãƒ“ãƒ«ãƒ‰å¼•æ•°ã¨ã—ã¦æ¸¡ã™
          build-args: |
            TURBO_API=${{ env.TURBO_API }}
            TURBO_TOKEN=${{ env.TURBO_TOKEN }}
            TURBO_TEAM=${{ env.TURBO_TEAM }}
          tags: |
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          # Dockerãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®šï¼ˆãƒ“ãƒ«ãƒ‰é«˜é€ŸåŒ–ï¼‰
          cache-from: type=registry,ref=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:cache
          cache-to: type=registry,ref=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:cache,mode=max

      # 12. Cloud Runã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Cloud Runã¸ãƒ‡ãƒ—ãƒ­ã‚¤
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          region: ${{ env.REGION }}
          # èªè¨¼ãªã—ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯
          # ãƒ¡ãƒ¢ãƒªåˆ¶é™: 1GB
          # CPUåˆ¶é™: 1ã‚³ã‚¢
          # æœ€å°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°: 0ï¼ˆã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰
          # æœ€å¤§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°: 10
          flags: |
            --allow-unauthenticated
            --memory=1Gi
            --cpu=1
            --min-instances=0
            --max-instances=10
